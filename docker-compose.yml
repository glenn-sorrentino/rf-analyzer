services:
  openwebrx:
    image: slechev/openwebrxplus:latest
    container_name: openwebrx
    devices:
      - /dev/bus/usb:/dev/bus/usb
    environment:
      OPENWEBRX_ADMIN_USER: admin
      OPENWEBRX_ADMIN_PASSWORD: STRONG_PASSWORD
    volumes:
      - ./openwebrx_data:/var/lib/openwebrx
    restart: unless-stopped
    profiles: ["ui"]

  recorder:
    image: debian:stable-slim
    container_name: iqrecorder
    devices:
      - /dev/bus/usb:/dev/bus/usb
    volumes:
      - /mnt/iqdata:/data
    command: >
      bash -lc "
        set -euo pipefail;
        apt-get update >/dev/null &&
        apt-get install -y --no-install-recommends hackrf coreutils >/dev/null;
        rate=8000000;
        while true; do
          ts=$(date -u +%Y%m%dT%H%M%SZ);
          out=/data/rec_${ts}.iq;
          echo Recording $out;
          hackrf_transfer -r - -f 1601000000 -s $rate -a 1 -l 32 -g 24 -b 10000000 -n $((rate*2*60)) > $out;
          find /data -type f -name '*.iq' -printf '%T+ %p\n' \
            | sort | head -n -1440 | cut -d' ' -f2- | xargs -r rm -f;
        done
      "
    restart: unless-stopped
    profiles: ["record"]

  hackrf-sweep:
    image: debian:stable-slim
    profiles: ["sweep"]
    privileged: true
    network_mode: host
    restart: unless-stopped
    devices:
      - /dev/bus/usb:/dev/bus/usb
    volumes:
      - /mnt/iqdata:/mnt/iqdata
    command: >
      bash -lc "
        set -euo pipefail;
        apt-get update -qq &&
        apt-get install -y --no-install-recommends hackrf coreutils &&
        mkdir -p /mnt/iqdata/sweeps;
        while true; do
          ts=$$(date -u +%Y%m%dT%H%M%SZ);
          outfile=/mnt/iqdata/sweeps/sweep_$${ts}.csv;
          echo '>> sweep' $$ts;
          timeout 60 hackrf_sweep -f 1:6000 -w 10000000 -r $$outfile || true;
          ls -1tr /mnt/iqdata/sweeps/sweep_*.csv | head -n -1440 | xargs -r rm -f;
        done"

  nginx:
    image: nginx:alpine
    ports:
      - "443:443"
      # (optional) redirect 80->443:
      # - "80:80"
    volumes:
      - ./certs:/etc/nginx/certs:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - openwebrx
    restart: unless-stopped
    profiles: ["ui"]
