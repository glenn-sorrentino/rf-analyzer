services:
  openwebrx:
    image: slechev/openwebrxplus:latest
    container_name: openwebrx
    devices:
      - /dev/bus/usb:/dev/bus/usb
    ports:
      - "8073:8073"
    environment:
      OPENWEBRX_ADMIN_USER: admin
      OPENWEBRX_ADMIN_PASSWORD: STRONG_PASSWORD
    volumes:
      - ./openwebrx_data:/var/lib/openwebrx
    restart: unless-stopped

  # optional; DO NOT run at the same time as OpenWebRX
  hackrf-sweep:
    image: debian:stable-slim
    profiles: ["sweep"]
    privileged: true
    network_mode: host
    restart: unless-stopped
    devices:
      - /dev/bus/usb:/dev/bus/usb
    volumes:
      - ./sweep_logs:/var/log/hackrf
    command: >
      bash -lc "apt-get update &&
                apt-get install -y --no-install-recommends hackrf &&
                mkdir -p /var/log/hackrf &&
                exec hackrf_sweep -f 1:6000 -w 10000000 -r /var/log/hackrf/hackrf_sweep.csv"

  nginx:
      image: nginx:alpine
      ports:
        - "443:443"
      volumes:
        - ./certs:/etc/nginx/certs:ro
      depends_on:
        - openwebrx
      command: >
        sh -c "cat <<EOF > /etc/nginx/conf.d/default.conf
        server {
          listen 443 ssl;
          server_name sdr.local;

          ssl_certificate /etc/nginx/certs/sdr.local+2.pem;
          ssl_certificate_key /etc/nginx/certs/sdr.local+2-key.pem;

          location / {
            proxy_pass http://openwebrx:8073;
            proxy_set_header Host \$\$host;
            proxy_set_header X-Real-IP \$\$remote_addr;
          }
        }
        EOF && nginx -g 'daemon off;'"
